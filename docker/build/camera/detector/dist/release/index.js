function key_face_detect_needed(e){var r=getPreviousFaceDetectionTs(e);if(ON_DEBUG&&console.log("key_face_detect_needed, lets say, 5fps frame rate, then 1 detect per sec"),!r)return setPreviousFaceDetectionTs(e,(new Date).getTime()),!0;var t=(new Date).getTime();return t-r>FACE_DETECTION_DURATION&&(setPreviousFaceDetectionTs(e,t),!0)}function checkAndNewCameraTrackerInfo(e){return e?(cameras_tracker[e]||(cameras_tracker[e]={tracker_id_alive_ts:0,current_tracker_id:0,current_faces_number:0,old_ts:0,previous_face_detection_ts:null,face_detect_in_processing:!1,saved_faces_motion:0}),!0):(console.log("checkAndNewCameraTrackerInfo no cameraId"),!1)}function increase_saved_faces_motion(e){if(!e||!checkAndNewCameraTrackerInfo(e))return 0;cameras_tracker[e].saved_faces_motion++}function get_saved_faces_motion(e){return e&&checkAndNewCameraTrackerInfo(e)?cameras_tracker[e].saved_faces_motion:0}function setCurrentFacesNumber(e,r){if(!e||!checkAndNewCameraTrackerInfo(e))return 0;cameras_tracker[e].current_faces_number=r}function getCurrentFacesNumber(e){return e&&checkAndNewCameraTrackerInfo(e)?cameras_tracker[e].current_faces_number:0}function getOldTimeStamp(e){return e&&checkAndNewCameraTrackerInfo(e)?cameras_tracker[e].old_ts:0}function setOldTimeStamp(e,r){if(!e||!checkAndNewCameraTrackerInfo(e))return 0;cameras_tracker[e].old_ts=r}function setPreviousFaceDetectionTs(e,r){if(!e||!checkAndNewCameraTrackerInfo(e))return 0;cameras_tracker[e].previous_face_detection_ts=r}function getPreviousFaceDetectionTs(e,r){return e&&checkAndNewCameraTrackerInfo(e)?cameras_tracker[e].previous_face_detection_ts:0}function getFaceDetectInProcessingStatus(e){return e&&checkAndNewCameraTrackerInfo(e)?cameras_tracker[e].face_detect_in_processing:0}function setFaceDetectInProcessingStatus(e,r){if(!e||!checkAndNewCameraTrackerInfo(e))return 0;cameras_tracker[e].face_detect_in_processing=r}function getCurrentTrackerId(e){return!e||cameras_tracker&&!cameras_tracker[e]?null:cameras_tracker[e].current_tracker_id}function stop_current_tracking(e){ON_DEBUG&&console.log("to stop_current_tracking: "+e),checkAndNewCameraTrackerInfo(e)&&(cameras_tracker[e].current_tracker_id="",cameras_tracker[e].tracker_id_alive_ts=null,cameras_tracker[e].current_faces_number=0,console.log("TODO: Pass tracker stopped event into system if needed, cameraId: "+e))}function extend_tracker_id_life_time(e){ON_DEBUG&&console.log("to extend_tracker_id_life_time[ts:"+cameras_tracker[e].current_tracker_id+"]: "+e),checkAndNewCameraTrackerInfo(e)&&(cameras_tracker[e].tracker_id_alive_ts=(new Date).getTime(),ON_DEBUG&&console.log("extend_tracker_id_life_time [ts:"+cameras_tracker[e].current_tracker_id+"] to: "+cameras_tracker[e].tracker_id_alive_ts))}function start_new_tracker_id(e){checkAndNewCameraTrackerInfo(e),ON_DEBUG&&console.log("to start_new_tracker_id "+cameras_tracker[e].current_tracker_id);var r=(new Date).getTime();cameras_tracker[e].tracker_id_alive_ts=r,cameras_tracker[e].current_tracker_id=r,console.log("start_new_tracker_id: "+cameras_tracker[e].current_tracker_id)}function is_in_tracking(e){if(!checkAndNewCameraTrackerInfo(e))return!1;if(!cameras_tracker[e].tracker_id_alive_ts)return!1;var r=(new Date).getTime()-cameras_tracker[e].tracker_id_alive_ts;return r<TRACKER_ID_SILIENCE_INTERVAL?(ON_DEBUG&&console.log("still in tracking"),!0):(ON_DEBUG&&console.log("Not in tracking, diff is "+r+" , < "+TRACKER_ID_SILIENCE_INTERVAL),!1)}function save_image_for_delayed_process(e,r){var t=getCurrentFacesNumber(e);t>0?(ON_DEBUG&&console.log("TODO: save and send to no priority task, faces: "+t+" camera: "+e),deepeye.saveCanvas2png(e,r,function(r,t){var a=(new Date).getTime();waitqueue.waitQueueInsert({cameraId:e,filepath:t,ts:a})})):ON_DEBUG&&console.log("No faces, no need to do image save")}function do_face_detection(e,r){deepeye.process(e,r,function(t,a,n,c,o){if(setFaceDetectInProcessingStatus(e,!1),ON_DEBUG&&console.log("detect callback"),t)return console.log(t),delete r,r=null,void maintainer.onError("face detection",t);delete r,r=null;var _=getCurrentTrackerId(e),i=getCurrentFacesNumber(e);if(setCurrentFacesNumber(e,a),a>=1?extend_tracker_id_life_time(e):0===a&&stop_current_tracking(e),check_and_generate_face_motion_gif(a,e,_,o),n>0){var s=getCurrentTrackerId(e);deepeye.embedding(c,s)}else 0===a&&0===i&&deepeye.delete_image(o)})}function check_and_generate_face_motion_gif(e,r,t,a){get_number_of_face_motion_saved_images("jpg",r,t,function(n){0===e?(ON_DEBUG&&console.log("end of current tracker id logic"),0===n?ON_DEBUG&&console.log("stop check: no face detected, Just need remove folder"):n>=10?ON_DEBUG&&console.log("stop check: already uploaded, Just need remove folder"):n>1&&(ON_DEBUG&&console.log("stop check: more than 1 saved, save/generate/upload/report/remove "),do_generate_gif_and_upload(r,t,a))):(ON_DEBUG&&console.log("in tracking logic"),9===n?(ON_DEBUG&&console.log("In time bingo: 9 face motion images saved, save/generate/upload/report "),do_generate_gif_and_upload(r,t,a)):n<9&&save_face_motion_image(r,t,a))})}function do_generate_gif_and_upload(e,r,t){save_face_motion_image(e,r,t,function(t,a){if(t)console.log(">>>> ERROR on save_face_motion_image");else{var n="face_motion/"+r+"/",c=e+"_"+r+".gif";makegif.generateGif("jpg",n,function(r,t){!r&&t?(ON_DEBUG&&console.log("Generated gif, need upload: "+t),upload.putFile(c,t,function(r,t){r?console.log(">>>> ERROR on save_face_motion_image"):(console.log("TODO: fill up information. Upload success, url is: "+t),REPORT_FACE_MOTION_TO_EVENT_SERVER&&send_face_motion_event_to_event_server("group_test_1_id","unknown",e,t))})):(console.log(">>>> ERROR on makegif.generateGif"),console.log(r),console.log(t))})}})}function get_face_motion_report_url(e,r,t,a){return FACE_MOTION_REPORT_SERVER_REQUEST_PREFIX+"img_url="+a+"#group_id="+e+"#faceid="+r+"#cameraId="+t}function send_face_motion_event_to_event_server(e,r,t,a){var n=get_face_motion_report_url(e,r,t,a);request.get(n,function(e,r,t){e?console.log(">>>> ERROR on request.get"):ON_DEBUG&&console.log("Report Face Motion event done")})}function get_number_of_face_motion_saved_images(e,r,t,a){readdir("face_motion/"+t+"/",function(r,t){if(r)a(0);else{var n=t.filter(function(r){return path.extname(r)==="."+e});a(n.length)}})}function save_face_motion_image(e,r,t,a){var n="face_motion/"+r+"/",c=n+path.basename(t);mkdirp(n,function(e){e?console.error(e):console.log("pow!"),mv(t,c,function(e){a&&a(e,c)})})}process.on("uncaughtException",function(e){console.error("uncaughtException",e)});var path=require("path"),mkdirp=require("mkdirp"),mv=require("mv"),request=require("request"),readdir=require("readdir-absolute"),motion=require("./motion"),deepeye=require("./deepeye"),makegif=require("./makegif"),upload=require("./upload"),waitqueue=require("./waitqueue"),maintainer=require("./maintainer"),ON_DEBUG=!1,FACE_DETECTION_DURATION=1e3,TRACKER_ID_SILIENCE_INTERVAL=3e3,FACE_MOTION_REPORT_SERVER_REQUEST_PREFIX="http://120.76.79.198:8080/timelines/add?",REPORT_FACE_MOTION_TO_EVENT_SERVER=!1,cameras_tracker={},onframe=function(e,r,t){ON_DEBUG&&console.log("onframe "+e+" motion detected frame has motion: "+t);var a=(new Date).getTime()-getOldTimeStamp(e);ON_DEBUG&&console.log(a),setOldTimeStamp(e,(new Date).getTime()),!0!==getFaceDetectInProcessingStatus(e)?!0===t?is_in_tracking(e)?(extend_tracker_id_life_time(e),key_face_detect_needed(e)?(setFaceDetectInProcessingStatus(e,!0),do_face_detection(e,r)):save_image_for_delayed_process(e,r)):(start_new_tracker_id(e),setFaceDetectInProcessingStatus(e,!0),do_face_detection(e,r)):is_in_tracking(e)&&stop_current_tracking(e):save_image_for_delayed_process(e,r)};motion.init(onframe),waitqueue.init();
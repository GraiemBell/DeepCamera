function get_device_SN(e){if(device_SN)return e&&e(null,device_SN);fs.readFile("/dev/ro_serialno","utf8",function(t,o){if(t)return e&&e(t,null);var n=o.split("\n");return n&&n[0]&&""!=n[0]?(device_SN=n[0],e&&e(null,device_SN)):e&&e(null,null)})}function canvas2jpg(e,t,o){var n=new Canvas(e.width,e.height);n.getContext("2d").drawImage(e.image,0,0,e.width,e.height);var i=t+"workai_"+(new Date).getTime()+".jpg",r=fs.createWriteStream(i),a=n.jpegStream();a.on("end",function(){return console.log("canvas2jpg end"),console.log("save as "+i),n=null,o&&o(null,i)}),a.on("error",function(e){console.log("canvas2jpg error: "+e)}),a.pipe(r)}function upload2python(e,t,o,n){var i=e.split("/"),r=i[i.length-1],a=fs.statSync(e);if(!t||!o)return n&&n("bad args");var s={host:"workaipython",port:"5000",method:"POST",timeout:1e4,path:"/api/fullimg/"+("?objid="+t+"&uuid="+o+"&ts="+(new Date).getTime())},g=http.request(s,function(e){e.on("data",function(e){console.log("BODY:"+e)})});g.on("error",function(e){return console.log("problem with request:"+e.message),console.log(e),n&&n(e)}),g.on("end",function(e){return console.log("req.on end:"),n&&n()});var c=Math.random().toString(16),u="\r\n----"+c+"--",d="\r\n----"+c+'\r\nContent-Type: application/octet-stream\r\nContent-Disposition: form-data; name="file"; filename="'+r+'"\r\nContent-Transfer-Encoding: binary\r\n\r\n',l=new Buffer(d,"utf-8"),m=l.length+a.size;g.setHeader("Content-Type","multipart/form-data; boundary=--"+c),g.setHeader("Content-Length",m+Buffer.byteLength(u)),g.write(l);var p=fs.createReadStream(e,{bufferSize:4096});p.pipe(g,{end:!1}),p.on("end",function(){return g.end(u),n&&n()})}function upload2python_onlyImagePath(e,t,o,n){var i={imgpath:e},r=qs.stringify(i),a={host:"workaipython",port:"5000",method:"POST",path:"/api/fullimg/"+("?objid="+t+"&uuid="+o+"&ts="+(new Date).getTime()),timeout:1e4,headers:{"Content-Type":"application/x-www-form-urlencoded","Content-Length":r.length}},s=http.request(a,function(e){var t="";e.on("data",function(e){t+=e}),e.on("end",function(){return console.log(t),n&&n(null,t)}),e.on("error",function(e){return n&&n(e,t)})});s.write(r),s.end()}function updateTrackerInfo(e,t,o,n){var i=(new Date).getTime();if(!s.group[t.ke][t.id].trackerid)return s.group[t.ke][t.id].trackerid=o+i,void(s.group[t.ke][t.id].lastTimeStatmp=i);if(e&&i-s.group[t.ke][t.id].lastTimeStatmp>4e3)s.group[t.ke][t.id].trackerid=o+i;else{if(e||!n||1!=n.totalpeople)return!e&&n&&n.totalpeople>1?(s.group[t.ke][t.id].lastTimeStatmp=Number(n.ts),void(s.group[t.ke][t.id].trackerid=o+n.ts)):void 0;s.group[t.ke][t.id].lastTimeStatmp=Number(n.ts)}}function post2workaipython(e,t){if(!(t<1e3)){var o=process.env.NODE_ENV||"/data/runtime/cache/";Math.floor((new Date).getTime()/1e3);get_device_SN(function(t,n){!t&&n&&(updateTrackerInfo(!0,e,n,null),canvas2jpg(e,o,function(t,o){fs.exists(o,function(t){t&&setTimeout(function(){var t=s.group[e.ke][e.id].trackerid;upload2python_onlyImagePath(o,t,n,function(t,o){updateTrackerInfo(!1,e,n,JSON.parse(o)),t?console.log("send image to python error: "+t):console.log("send image to python successed")})},50)})}))})}}function fastAbs(e){return(e^e>>31)-(e>>31)}function threshold(e){return e>21?255:0}function difference(e,t,o){if(t.length!=o.length)return null;for(var n=0;n<.25*t.length;)e[4*n]=0==t[4*n]?0:fastAbs(t[4*n]-o[4*n]),e[4*n+1]=0==t[4*n+1]?0:fastAbs(t[4*n+1]-o[4*n+1]),e[4*n+2]=0==t[4*n+2]?0:fastAbs(t[4*n+2]-o[4*n+2]),e[4*n+3]=255,++n}process.on("uncaughtException",function(e){console.error("uncaughtException",e)});var fs=require("fs"),moment=require("moment"),Canvas=require("canvas"),config=require("./conf.json"),http=require("http"),fs=require("fs"),qs=require("querystring"),device_SN=null;process.argv[2]&&process.argv[3]&&(config.host=process.argv[2],config.port=process.argv[3],config.key=process.argv[4]),void 0===config.systemLog&&(config.systemLog=!0),s={group:{}},s.systemLog=function(e,t,o){if(t||(t=""),o||(o=""),!0===config.systemLog)return console.log(moment().format(),e,t,o)},s.blenderRegion=function(e,t){if(e.width=e.image.width,e.height=e.image.height,!s.group[e.ke][e.id].canvas[t.name]&&(t.sensitivity&&!isNaN(t.sensitivity)||e.mon.detector_sensitivity,s.group[e.ke][e.id].canvas[t.name]=new Canvas(e.width,e.height),s.group[e.ke][e.id].canvasContext[t.name]=s.group[e.ke][e.id].canvas[t.name].getContext("2d"),s.group[e.ke][e.id].canvasContext[t.name].fillStyle="#005337",s.group[e.ke][e.id].canvasContext[t.name].fillRect(0,0,e.width,e.height),t.points&&t.points.length>0)){s.group[e.ke][e.id].canvasContext[t.name].beginPath();for(var o=0;o<t.points.length;o++)t.points[o][0]=parseFloat(t.points[o][0]),t.points[o][1]=parseFloat(t.points[o][1]),0===o?s.group[e.ke][e.id].canvasContext[t.name].moveTo(t.points[o][0],t.points[o][1]):s.group[e.ke][e.id].canvasContext[t.name].lineTo(t.points[o][0],t.points[o][1]);s.group[e.ke][e.id].canvasContext[t.name].clip()}if(s.group[e.ke][e.id].canvasContext[t.name]){s.group[e.ke][e.id].canvasContext[t.name].drawImage(e.image,0,0,e.width,e.height),s.group[e.ke][e.id].blendRegion[t.name]||(s.group[e.ke][e.id].blendRegion[t.name]=new Canvas(e.width,e.height),s.group[e.ke][e.id].blendRegionContext[t.name]=s.group[e.ke][e.id].blendRegion[t.name].getContext("2d"));var n=s.group[e.ke][e.id].canvasContext[t.name].getImageData(0,0,e.width,e.height);s.group[e.ke][e.id].lastRegionImageData[t.name]||(s.group[e.ke][e.id].lastRegionImageData[t.name]=s.group[e.ke][e.id].canvasContext[t.name].getImageData(0,0,e.width,e.height));var i=s.group[e.ke][e.id].canvasContext[t.name].createImageData(e.width,e.height);s.differenceAccuracy(i.data,n.data,s.group[e.ke][e.id].lastRegionImageData[t.name].data),s.group[e.ke][e.id].blendRegionContext[t.name].putImageData(i,0,0),s.group[e.ke][e.id].lastRegionImageData[t.name]=n,i=s.group[e.ke][e.id].blendRegionContext[t.name].getImageData(0,0,e.width,e.height);for(var r=0,a=0;r<.25*i.data.length;)a+=i.data[4*r]+i.data[4*r+1]+i.data[4*r+2],++r;(a=a/(.25*i.data.length)*10)>parseFloat(t.sensitivity)?(s.cx({f:"trigger",id:e.id,ke:e.ke,details:{plug:config.plug,name:t.name,reason:"motion",confidence:a}}),console.log("Has motion, average: "+a),post2workaipython(e,a)):console.log("Sensitivity is "+parseFloat(t.sensitivity)+" average is "+a),s.group[e.ke][e.id].canvasContext[t.name].clearRect(0,0,e.width,e.height),s.group[e.ke][e.id].blendRegionContext[t.name].clearRect(0,0,e.width,e.height)}},s.differenceAccuracy=function(e,t,o){if(t.length!=o.length)return null;for(var n=0;n<.25*t.length;){var i=threshold(fastAbs((t[4*n]+t[4*n+1]+t[4*n+2])/3-(o[4*n]+o[4*n+1]+o[4*n+2])/3));e[4*n]=i,e[4*n+1]=i,e[4*n+2]=i,e[4*n+3]=255,++n}},s.checkAreas=function(e){s.group[e.ke][e.id].cords||(e.mon.cords||(e.mon.cords={}),s.group[e.ke][e.id].cords=Object.values(e.mon.cords)),"1"===e.mon.detector_frame&&(e.mon.cords.frame={name:"frame",s:e.mon.detector_sensitivity,points:[[0,0],[0,e.image.height],[e.image.width,e.image.height],[e.image.width,0]]},s.group[e.ke][e.id].cords.push(e.mon.cords.frame));for(var t=0;t<s.group[e.ke][e.id].cords.length;t++){if(!s.group[e.ke][e.id].cords[t])return;s.blenderRegion(e,s.group[e.ke][e.id].cords[t])}delete e.image},io=require("socket.io-client")("ws://"+config.host+":"+config.port),s.cx=function(e){return e.pluginKey=config.key,e.plug=config.plug,io.emit("ocv",e)},io.on("connect",function(e){s.cx({f:"init",plug:config.plug,notice:config.notice,type:config.type})}),io.on("disconnect",function(e){io.connect()}),io.on("f",function(e){switch(e.f){case"init_monitor":console.log("init_monitor"),s.group[e.ke]&&s.group[e.ke][e.id]&&(s.group[e.ke][e.id].canvas={},s.group[e.ke][e.id].canvasContext={},s.group[e.ke][e.id].blendRegion={},s.group[e.ke][e.id].blendRegionContext={},s.group[e.ke][e.id].lastRegionImageData={},s.group[e.ke][e.id].trackerid=null,s.group[e.ke][e.id].lastTimeStatmp=null,delete s.group[e.ke][e.id].cords,delete s.group[e.ke][e.id].buffer);break;case"frame":var t=(new Date).getTime(),o=(new Date).getTime();try{if(s.group[e.ke]||(s.group[e.ke]={}),s.group[e.ke][e.id]||(s.group[e.ke][e.id]={canvas:{},canvasContext:{},lastRegionImageData:{},blendRegion:{},blendRegionContext:{}}),s.group[e.ke][e.id].buffer?s.group[e.ke][e.id].buffer.push(e.frame):s.group[e.ke][e.id].buffer=[e.frame],255===e.frame[e.frame.length-2]&&217===e.frame[e.frame.length-1]){if(s.group[e.ke][e.id].motion_lock)return;if(e.mon.detector_lock_timeout&&""!==e.mon.detector_lock_timeout&&0!=e.mon.detector_lock_timeout?e.mon.detector_lock_timeout=parseFloat(e.mon.detector_lock_timeout):e.mon.detector_lock_timeout=2e3,s.group[e.ke][e.id].motion_lock=setTimeout(function(){clearTimeout(s.group[e.ke][e.id].motion_lock),delete s.group[e.ke][e.id].motion_lock},e.mon.detector_lock_timeout),s.group[e.ke][e.id].buffer=Buffer.concat(s.group[e.ke][e.id].buffer),"string"==typeof e.mon.cords&&""===e.mon.cords.trim())e.mon.cords=[];else try{e.mon.cords=JSON.parse(e.mon.cords)}catch(e){}if(s.systemLog("3"),"1"===e.mon.detector_frame_save&&(e.base64=s.group[e.ke][e.id].buffer.toString("base64")),s.group[e.ke][e.id].cords=Object.values(e.mon.cords),e.mon.cords=e.mon.cords,e.image=new Canvas.Image,""===e.mon.detector_scale_x||""===e.mon.detector_scale_y)return s.systemLog("4"),void s.systemLog("Must set detector image size");e.image.width=e.mon.detector_scale_x,e.image.height=e.mon.detector_scale_y,e.image.onload=function(){s.checkAreas(e),o=(new Date).getTime(),console.log(">>> "+(o-t))},console.log(s.group[e.ke][e.id].buffer.length),e.image.src=s.group[e.ke][e.id].buffer,s.group[e.ke][e.id].buffer=null}}catch(t){t&&(s.systemLog(t),delete s.group[e.ke][e.id].buffer)}}});
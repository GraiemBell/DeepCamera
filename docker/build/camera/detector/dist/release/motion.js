var Canvas=require("canvas"),moment=require("moment"),config=require("./conf.json"),s={group:{},has_motion:!1},ON_DEBUG=!1;module.exports={init:function(e){function o(e){return(e^e>>31)-(e>>31)}function t(e){return e>21?255:0}process.argv[2]&&process.argv[3]&&(config.host=process.argv[2],config.port=process.argv[3],config.key=process.argv[4]),void 0===config.systemLog&&(config.systemLog=!0),s.systemLog=function(e,o,t){if(o||(o=""),t||(t=""),!0===config.systemLog)return console.log(moment().format(),e,o,t)},s.blenderRegion=function(e,o){var t=!1;if(e.width=e.image.width,e.height=e.image.height,!s.group[e.ke][e.id].canvas[o.name]&&(o.sensitivity&&!isNaN(o.sensitivity)||(o.sensitivity=e.mon.detector_sensitivity),s.group[e.ke][e.id].canvas[o.name]=new Canvas(e.width,e.height),s.group[e.ke][e.id].canvasContext[o.name]=s.group[e.ke][e.id].canvas[o.name].getContext("2d"),s.group[e.ke][e.id].canvasContext[o.name].fillStyle="#005337",s.group[e.ke][e.id].canvasContext[o.name].fillRect(0,0,e.width,e.height),o.points&&o.points.length>0)){s.group[e.ke][e.id].canvasContext[o.name].beginPath();for(var n=0;n<o.points.length;n++)o.points[n][0]=parseFloat(o.points[n][0]),o.points[n][1]=parseFloat(o.points[n][1]),0===n?s.group[e.ke][e.id].canvasContext[o.name].moveTo(o.points[n][0],o.points[n][1]):s.group[e.ke][e.id].canvasContext[o.name].lineTo(o.points[n][0],o.points[n][1]);s.group[e.ke][e.id].canvasContext[o.name].clip()}if(s.group[e.ke][e.id].canvasContext[o.name]){s.group[e.ke][e.id].canvasContext[o.name].drawImage(e.image,0,0,e.width,e.height),s.group[e.ke][e.id].blendRegion[o.name]||(s.group[e.ke][e.id].blendRegion[o.name]=new Canvas(e.width,e.height),s.group[e.ke][e.id].blendRegionContext[o.name]=s.group[e.ke][e.id].blendRegion[o.name].getContext("2d"));var i=s.group[e.ke][e.id].canvasContext[o.name].getImageData(0,0,e.width,e.height);s.group[e.ke][e.id].lastRegionImageData[o.name]||(s.group[e.ke][e.id].lastRegionImageData[o.name]=s.group[e.ke][e.id].canvasContext[o.name].getImageData(0,0,e.width,e.height));var a=s.group[e.ke][e.id].canvasContext[o.name].createImageData(e.width,e.height);s.differenceAccuracy(a.data,i.data,s.group[e.ke][e.id].lastRegionImageData[o.name].data),s.group[e.ke][e.id].blendRegionContext[o.name].putImageData(a,0,0),s.group[e.ke][e.id].lastRegionImageData[o.name]=i,a=s.group[e.ke][e.id].blendRegionContext[o.name].getImageData(0,0,e.width,e.height);for(var r=0,g=0;r<.25*a.data.length;)g+=a.data[4*r]+a.data[4*r+1]+a.data[4*r+2],++r;return g=g/(.25*a.data.length)*10,o.sensitivity&&!isNaN(o.sensitivity)||(o.sensitivity=e.mon.detector_sensitivity),g>parseFloat(o.sensitivity)?(s.cx({f:"trigger",id:e.id,ke:e.ke,details:{plug:config.plug,name:o.name,reason:"motion",confidence:g}}),ON_DEBUG&&console.log("Has motion, average: "+g),t=!0):(ON_DEBUG&&console.log("Sensitivity is "+parseFloat(o.sensitivity)+" average is "+g),t=!1),s.group[e.ke][e.id].canvasContext[o.name].clearRect(0,0,e.width,e.height),s.group[e.ke][e.id].blendRegionContext[o.name].clearRect(0,0,e.width,e.height),t}},s.differenceAccuracy=function(e,n,i){if(n.length!=i.length)return null;for(var s=0;s<.25*n.length;){var a=t(o((n[4*s]+n[4*s+1]+n[4*s+2])/3-(i[4*s]+i[4*s+1]+i[4*s+2])/3));e[4*s]=a,e[4*s+1]=a,e[4*s+2]=a,e[4*s+3]=255,++s}},s.checkAreas=function(e){s.group[e.ke][e.id].cords||(e.mon.cords||(e.mon.cords={}),s.group[e.ke][e.id].cords=Object.values(e.mon.cords)),"1"===e.mon.detector_frame&&(e.mon.cords.frame={name:"frame",s:e.mon.detector_sensitivity,points:[[0,0],[0,e.image.height],[e.image.width,e.image.height],[e.image.width,0]]},s.group[e.ke][e.id].cords.push(e.mon.cords.frame));for(var o=!1,t=0;t<s.group[e.ke][e.id].cords.length;t++){if(!s.group[e.ke][e.id].cords[t])return;s.blenderRegion(e,s.group[e.ke][e.id].cords[t])&&(o=!0)}return ON_DEBUG&&console.log("Dont forget to delete image, has motion: "+o),o};var n=require("socket.io-client")("ws://"+config.host+":"+config.port);s.cx=function(e){return e.pluginKey=config.key,e.plug=config.plug,n.emit("ocv",e)},n.on("connect",function(e){s.cx({f:"init",plug:config.plug,notice:config.notice,type:config.type})}),n.on("disconnect",function(e){n.connect()});var i=function(o,t){if(s.group[o.ke][o.id].buffer=Buffer.concat(s.group[o.ke][o.id].buffer),"string"==typeof o.mon.cords&&""===o.mon.cords.trim())o.mon.cords=[];else try{o.mon.cords=JSON.parse(o.mon.cords)}catch(e){}"1"===o.mon.detector_frame_save&&(o.base64=s.group[o.ke][o.id].buffer.toString("base64")),s.group[o.ke][o.id].cords=Object.values(o.mon.cords),o.mon.cords=o.mon.cords,o.image=new Canvas.Image,""!==o.mon.detector_scale_x&&""!==o.mon.detector_scale_y?(o.image.width=o.mon.detector_scale_x,o.image.height=o.mon.detector_scale_y,o.image.onload=function(){t&&(s.has_motion=s.checkAreas(o)),e(o.id,o.image,s.has_motion),delete o.image},ON_DEBUG&&console.log(s.group[o.ke][o.id].buffer.length),o.image.src=s.group[o.ke][o.id].buffer,s.group[o.ke][o.id].buffer=null):s.systemLog("Must set detector image size")};n.on("f",function(e){switch(e.f){case"api_key":s.api_key=e.key,console.log("API Key from server is "+s.api_key);case"init_monitor":console.log("init_monitor"),s.group[e.ke]&&s.group[e.ke][e.id]&&(s.group[e.ke][e.id].canvas={},s.group[e.ke][e.id].canvasContext={},s.group[e.ke][e.id].blendRegion={},s.group[e.ke][e.id].blendRegionContext={},s.group[e.ke][e.id].lastRegionImageData={},s.group[e.ke][e.id].trackerid=null,s.group[e.ke][e.id].lastTimeStatmp=null,delete s.group[e.ke][e.id].cords,delete s.group[e.ke][e.id].buffer);break;case"frame":(new Date).getTime(),(new Date).getTime();try{if(s.group[e.ke]||(s.group[e.ke]={}),s.group[e.ke][e.id]||(s.group[e.ke][e.id]={canvas:{},canvasContext:{},lastRegionImageData:{},blendRegion:{},blendRegionContext:{}}),s.group[e.ke][e.id].buffer?s.group[e.ke][e.id].buffer.push(e.frame):s.group[e.ke][e.id].buffer=[e.frame],255===e.frame[e.frame.length-2]&&217===e.frame[e.frame.length-1]){if(s.group[e.ke][e.id].motion_lock)return ON_DEBUG&&console.log("log on frame"),void i(e,!1);e.mon.detector_lock_timeout&&""!==e.mon.detector_lock_timeout&&0!=e.mon.detector_lock_timeout?e.mon.detector_lock_timeout=parseFloat(e.mon.detector_lock_timeout):e.mon.detector_lock_timeout=2e3,s.group[e.ke][e.id].motion_lock=setTimeout(function(){clearTimeout(s.group[e.ke][e.id].motion_lock),delete s.group[e.ke][e.id].motion_lock},e.mon.detector_lock_timeout),i(e,!0)}}catch(o){o&&(s.systemLog(o),delete s.group[e.ke][e.id].buffer)}}})}};
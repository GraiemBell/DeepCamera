function detect_task(e,t,n,o,l){request({url:detect_task_url,method:"POST",json:!0,body:{args:[e,t,n,o]}},function(e,t,n){return e?(console.log(e),l&&l(e,0,null)):(ON_DEBUG&&console.log(n),n&&"SUCCESS"==n.state&&n.result&&(json=JSON.parse(n.result),json.totalmtcnn>0||json.detected&&json.totalPeople>0)?l&&l(null,json.totalmtcnn,json.cropped):l&&l(null,0,[]))})}function embedding_task(e,t){request({url:embedding_task_url,method:"POST",json:!0,body:{args:[e]}},function(e,n,o){return e?(console.log(e),t&&t(e,null)):(ON_DEBUG&&console.log(o),t&&t(null,o))})}function get_device_SN(e){if(device_SN)return e&&e(null,device_SN);fs.readFile("/dev/ro_serialno","utf8",function(t,n){if(t)return e&&e(t,null);var o=n.split("\n");return o&&o[0]&&""!=o[0]?(device_SN=o[0],e&&e(null,device_SN)):e&&e(null,null)})}function canvas2png(e,t,n,o){var l=new Canvas(t.width,t.height);l.getContext("2d").drawImage(t,0,0,t.width,t.height);var s=n+"/deepeye_"+e+"_"+(new Date).getTime()+".jpg",r=fs.createWriteStream(s),u=l.jpegStream({bufsize:4096,quality:100});u.on("end",function(){return ON_DEBUG&&console.log("canvas2jpg end"),ON_DEBUG&&console.log("save as "+s),l=null,o&&o(null,s)}),u.on("error",function(e){console.log("canvas2jpg error: "+e)}),u.pipe(r)}function delete_image(e){fs.exists(e,function(t){t&&fs.unlink(e,function(t){t?console.log(t):ON_DEBUG&&console.log("remove file: "+e)})})}var Canvas=require("canvas"),fs=require("fs"),http=require("http"),qs=require("querystring"),path=require("path"),request=require("request"),device_SN=null,host_ip="workaipython",detect_task_url="http://"+host_ip+":5555/api/task/apply/upload_api-v2.detect",detect_task_queues_length="http://"+host_ip+":5555/api/tasks?limit=100&state=STARTED&workername=celery%40detect",embedding_task_url="http://"+host_ip+":5555/api/task/async-apply/upload_api-v2.extract",IMAGE_DIR=process.env.NODE_ENV||"/opt/nvr/detector/images",ON_DEBUG=!1;module.exports={delete_image:delete_image,process:function(e,t,n){var o=(new Date).getTime(),l=o;canvas2png(e,t,IMAGE_DIR,function(t,s){fs.exists(s,function(t){if(!t)return n&&n("file not found !!",0,0,[],null);detect_task(s,l,o,e,function(e,t,o){return e||!o?(delete_image(s),console.log(e),console.log(o),n&&n("add detect_task failed!!",0,0,[],null)):n&&n(null,t,o.length,o,s)})})})},processSavedTask:function(e,t,n,o){detect_task(t,n,n,e,function(e,n,l){return delete_image(t),e||!l?(console.log(e),console.log(l),o&&o("add detect_task failed!!",0,[])):o&&o(null,l.length,l)})},saveCanvas2png:function(e,t,n){canvas2png(e,t,IMAGE_DIR,function(e,t){return n&&n(e,t)})},getQueueLenth:function(e){request({url:detect_task_queues_length,method:"GET",json:!0},function(t,n,o){return t?(console.log(t),e&&e(t,100)):o?(ON_DEBUG&&console.log(o),e&&e(null,Object.keys(o).length)):(console.log(">>>> ERROR When flower dont response queue request"),console.log(o),e&&e(null,100))})},embedding:function(e,t){for(var n=0;n<e.length;n++){var o=e[n];t&&(o.trackerid=t),ON_DEBUG&&console.log(o),embedding_task(o,function(e){})}}};
process.on("uncaughtException",function(e){console.error("uncaughtException",e)});var fs=require("fs"),moment=require("moment"),Canvas=require("canvas"),Cluster=require("./libs/clusterPoints.js"),config=require("./conf.json");process.argv[2]&&process.argv[3]&&(config.host=process.argv[2],config.port=process.argv[3],config.key=process.argv[4]),void 0===config.systemLog&&(config.systemLog=!0),s={group:{}},s.systemLog=function(e,t,o){if(t||(t=""),o||(o=""),!0===config.systemLog)return console.log(moment().format(),e,t,o)},s.checkRegion=function(e,t){if(e.width=e.image.width,e.height=e.image.height,!s.group[e.ke][e.id].canvas[t.name]&&(t.sensitivity&&!isNaN(t.sensitivity)||(t.sensitivity=e.mon.detector_sensitivity),s.group[e.ke][e.id].canvas[t.name]=new Canvas(e.width,e.height),s.group[e.ke][e.id].canvasContext[t.name]=s.group[e.ke][e.id].canvas[t.name].getContext("2d"),s.group[e.ke][e.id].canvasContext[t.name].fillStyle="#005337",s.group[e.ke][e.id].canvasContext[t.name].fillRect(0,0,e.width,e.height),t.points&&t.points.length>0)){s.group[e.ke][e.id].canvasContext[t.name].beginPath();for(var o=0;o<t.points.length;o++)t.points[o][0]=parseFloat(t.points[o][0]),t.points[o][1]=parseFloat(t.points[o][1]),0===o?s.group[e.ke][e.id].canvasContext[t.name].moveTo(t.points[o][0],t.points[o][1]):s.group[e.ke][e.id].canvasContext[t.name].lineTo(t.points[o][0],t.points[o][1]);s.group[e.ke][e.id].canvasContext[t.name].clip()}s.group[e.ke][e.id].canvasContext[t.name].drawImage(e.image,0,0,e.width,e.height);var i=s.group[e.ke][e.id].canvas[t.name],a=s.group[e.ke][e.id].canvasContext[t.name];if(s.group[e.ke][e.id].frameSelected[s.group[e.ke][e.id].frameNumber]=a.getImageData(0,0,i.width,i.height),s.group[e.ke][e.id].frameNumber=0==s.group[e.ke][e.id].frameNumber?1:0,s.group[e.ke][e.id].lastRegionImageData=a.getImageData(0,0,i.width,i.height),s.group[e.ke][e.id].lastRegionImageData){var r=[],n=0,g=.25*s.group[e.ke][e.id].lastRegionImageData.data.length;for(o=0;o<g;){var d=4*o;if(s.group[e.ke][e.id].lastRegionImageData.data[d]=.5*(255-s.group[e.ke][e.id].lastRegionImageData.data[d])+.5*s.group[e.ke][e.id].frameSelected[s.group[e.ke][e.id].frameNumber].data[d],s.group[e.ke][e.id].lastRegionImageData.data[d+1]=.5*(255-s.group[e.ke][e.id].lastRegionImageData.data[d+1])+.5*s.group[e.ke][e.id].frameSelected[s.group[e.ke][e.id].frameNumber].data[d+1],s.group[e.ke][e.id].lastRegionImageData.data[d+2]=.5*(255-s.group[e.ke][e.id].lastRegionImageData.data[d+2])+.5*s.group[e.ke][e.id].frameSelected[s.group[e.ke][e.id].frameNumber].data[d+2],s.group[e.ke][e.id].lastRegionImageData.data[d+3]=255,(s.group[e.ke][e.id].lastRegionImageData.data[d]+s.group[e.ke][e.id].lastRegionImageData.data[d+1]+s.group[e.ke][e.id].lastRegionImageData.data[d+2])/3>170){var c=d/4%e.width,m=Math.floor(d/4/e.width);r.push([c,m])}n+=s.group[e.ke][e.id].lastRegionImageData.data[4*o]+s.group[e.ke][e.id].lastRegionImageData.data[4*o+1]+s.group[e.ke][e.id].lastRegionImageData.data[4*o+2],o+=4}if("1"===e.mon.detector_region_of_interest&&r.length>0){var u=Object.assign({},Cluster);u.iterations(25),u.data(r);var p=[],f=0,k=0,l=null;(u=u.clusters()).forEach(function(t,o){var i={topLeft:[e.width,e.height],topRight:[0,e.height],bottomRight:[0,0],bottomLeft:[e.width,0]};t.points.forEach(function(e){var t=e[0],o=e[1];t<i.topLeft[0]&&(i.topLeft[0]=t),o<i.topLeft[1]&&(i.topLeft[1]=o),t>i.topRight[0]&&(i.topRight[0]=t),o<i.topRight[1]&&(i.topRight[1]=o),t>i.bottomRight[0]&&(i.bottomRight[0]=t),o>i.bottomRight[1]&&(i.bottomRight[1]=o),t<i.bottomLeft[0]&&(i.bottomLeft[0]=t),o>i.bottomLeft[1]&&(i.bottomLeft[1]=o)}),i.x=i.topLeft[0],i.y=i.topLeft[1],i.width=i.topRight[0]-i.topLeft[0],i.height=i.bottomLeft[1]-i.topLeft[1],i.width>k&&i.height>f&&(k=i.width,f=i.height,l=i),p.push(i)})}(n/=g)>parseFloat(t.sensitivity)&&s.cx({f:"trigger",id:e.id,ke:e.ke,details:{plug:config.plug,name:t.name,reason:"motion",confidence:n,matrices:p}}),s.group[e.ke][e.id].canvasContext[t.name].clearRect(0,0,e.width,e.height)}},s.checkAreas=function(e){s.group[e.ke][e.id].cords||(e.mon.cords||(e.mon.cords={}),s.group[e.ke][e.id].cords=Object.values(e.mon.cords)),"1"===e.mon.detector_frame&&(e.mon.cords.frame={name:"frame",s:e.mon.detector_sensitivity,points:[[0,0],[0,e.image.height],[e.image.width,e.image.height],[e.image.width,0]]},s.group[e.ke][e.id].cords.push(e.mon.cords.frame));for(var t=0;t<s.group[e.ke][e.id].cords.length;t++){if(!s.group[e.ke][e.id].cords[t])return;s.checkRegion(e,s.group[e.ke][e.id].cords[t])}delete e.image},io=require("socket.io-client")("ws://"+config.host+":"+config.port),s.cx=function(e){return e.pluginKey=config.key,e.plug=config.plug,io.emit("ocv",e)},io.on("connect",function(e){s.cx({f:"init",plug:config.plug,notice:config.notice})}),io.on("disconnect",function(e){io.connect()}),io.on("f",function(e){switch(e.f){case"init_monitor":s.group[e.ke]&&s.group[e.ke][e.id]&&(s.group[e.ke][e.id].canvas={},s.group[e.ke][e.id].canvasContext={},s.group[e.ke][e.id].lastRegionImageData=void 0,s.group[e.ke][e.id].frameNumber=0,s.group[e.ke][e.id].frameSelected=[],delete s.group[e.ke][e.id].cords,delete s.group[e.ke][e.id].buffer);break;case"frame":try{if(s.group[e.ke]||(s.group[e.ke]={}),s.group[e.ke][e.id]||(s.group[e.ke][e.id]={canvas:{},canvasContext:{},lastRegionImageData:void 0,frameNumber:0,frameSelected:[]}),s.group[e.ke][e.id].buffer?s.group[e.ke][e.id].buffer.push(e.frame):s.group[e.ke][e.id].buffer=[e.frame],255===e.frame[e.frame.length-2]&&217===e.frame[e.frame.length-1]){if(s.group[e.ke][e.id].motion_lock)return;if(e.mon.detector_lock_timeout&&""!==e.mon.detector_lock_timeout&&0!=e.mon.detector_lock_timeout?e.mon.detector_lock_timeout=parseFloat(e.mon.detector_lock_timeout):e.mon.detector_lock_timeout=2e3,s.group[e.ke][e.id].motion_lock=setTimeout(function(){clearTimeout(s.group[e.ke][e.id].motion_lock),delete s.group[e.ke][e.id].motion_lock},e.mon.detector_lock_timeout),s.group[e.ke][e.id].buffer=Buffer.concat(s.group[e.ke][e.id].buffer),"string"==typeof e.mon.cords&&""===e.mon.cords.trim())e.mon.cords=[];else try{e.mon.cords=JSON.parse(e.mon.cords)}catch(e){}if("1"===e.mon.detector_frame_save&&(e.base64=s.group[e.ke][e.id].buffer.toString("base64")),s.group[e.ke][e.id].cords=Object.values(e.mon.cords),e.mon.cords=e.mon.cords,e.image=new Canvas.Image,""===e.mon.detector_scale_x||""===e.mon.detector_scale_y)return void s.systemLog("Must set detector image size");e.image.width=e.mon.detector_scale_x,e.image.height=e.mon.detector_scale_y,e.image.onload=function(){s.checkAreas(e)},e.image.src=s.group[e.ke][e.id].buffer,s.group[e.ke][e.id].buffer=null}}catch(t){t&&(s.systemLog(t),delete s.group[e.ke][e.id].buffer)}}});